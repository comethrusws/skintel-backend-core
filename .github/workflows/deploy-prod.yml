name: Production Deploy to AWS

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create and deploy archive
        run: |
          # Create archive in /tmp, then move it
          tar --exclude-vcs --exclude='*.tar.gz' -czf /tmp/skintel-backend-core.tar.gz .
          mv /tmp/skintel-backend-core.tar.gz .
          
          # Create SSH key file
          echo "${{ secrets.SSH_KEY_PROD }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          # Upload to server
          scp -i /tmp/ssh_key -o StrictHostKeyChecking=no \
            skintel-backend-core.tar.gz ${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }}:/home/admin/
          
          # Deploy on server
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }} << 'EOF'
            cd /home/admin
            rm -rf skintel-backend-core
            mkdir -p skintel-backend-core
            tar -xzf skintel-backend-core.tar.gz -C skintel-backend-core
            rm skintel-backend-core.tar.gz
            cd skintel-backend-core
            
            # Create .env file with properly quoted secrets
            cat > .env << 'ENVEOF'
          NODE_ENV="${{ secrets.NODE_ENV }}"
          API_BASE_URL="${{ secrets.API_BASE_URL_PROD }}"
          MAX_REQUEST_SIZE="${{ secrets.MAX_REQUEST_SIZE }}"
          PORT="${{ secrets.PORT }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          AWS_REGION="${{ secrets.AWS_REGION_PROD }}"
          IOS_BUNDLE_ID="${{ secrets.IOS_BUNDLE_ID }}"
          APPLE_SHARED_SECRET="${{ secrets.APPLE_SHARED_SECRET }}"
          S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME_PROD }}"
          S3_PUBLIC_BASE_URL="${{ secrets.S3_PUBLIC_BASE_URL_PROD }}"
          S3_OBJECT_ACL="${{ secrets.S3_OBJECT_ACL_PROD }}"
          APPLE_ISSUER_ID="${{ secrets.APPLE_ISSUER_ID }}"
          APPLE_KEY_ID="${{ secrets.APPLE_KEY_ID }}"
          APPLE_BUNDLE_ID="${{ secrets.APPLE_BUNDLE_ID }}"
          APPLE_API_URL_PRODUCTION="${{ secrets.APPLE_API_URL_PRODUCTION }}"
          APPLE_API_URL_SANDBOX="${{ secrets.APPLE_API_URL_SANDBOX }}"
          OPENWEATHER_API_KEY="${{ secrets.OPENWEATHER_API_KEY }}"
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          CLERK_SECRET_KEY="${{ secrets.CLERK_SECRET_KEY }}"
          CLERK_PUBLISHABLE_KEY="${{ secrets.CLERK_PUBLISHABLE_KEY }}"
          FIREBASE_SERVICE_ACCOUNT='${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          SENTRY_DSN="${{ secrets.SENTRY_DSN_PROD }}"
          DATABASE_URL="${{ secrets.DATABASE_URL_PROD }}"
          ENVEOF
            
            # Stop existing services and start new ones with minimal downtime
            sudo docker compose -f docker-compose.prod.yml down || true
            # added as temp fix
            sudo docker system prune -f
            sudo docker compose -f docker-compose.prod.yml build --no-cache
            sudo docker compose -f docker-compose.prod.yml up -d --force-recreate  # Clean up unused images/containers
          # sudo docker compose -f docker-compose.prod.yml up -d --build --force-recreate
          EOF
          
          # Clean up SSH key
          rm -f /tmp/ssh_key
