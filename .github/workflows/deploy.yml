name: Deploy to AWS (EC2 via SCP + Docker Compose)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create and deploy archive
        run: |
          # Create archive in /tmp, then move it
          tar --exclude-vcs --exclude='*.tar.gz' -czf /tmp/skintel-backend-core.tar.gz .
          mv /tmp/skintel-backend-core.tar.gz .
          
          # Upload to server
          scp -i <(echo "${{ secrets.SSH_KEY }}") -o StrictHostKeyChecking=no \
            skintel-backend-core.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/admin/
          
          # Deploy on server
          ssh -i <(echo "${{ secrets.SSH_KEY }}") -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/admin
            rm -rf skintel-backend-core
            mkdir -p skintel-backend-core
            tar -xzf skintel-backend-core.tar.gz -C skintel-backend-core
            rm skintel-backend-core.tar.gz
            cd skintel-backend-core
            sudo docker compose down || true
            sudo docker compose up -d --build
          EOF
